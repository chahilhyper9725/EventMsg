<!DOCTYPE html>
<html>
<head>
    <title>EventMsg BLE Tester</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        button {
            margin: 5px;
            padding: 10px;
        }

        #log {
            border: 1px solid #ccc;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
        }

        .stats {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
        }

        .form-group {
            margin: 10px 0;
        }

        label {
            display: inline-block;
            width: 100px;
        }
    </style>
</head>

<body>
    <h1>EventMsg BLE Tester</h1>

    <button id="connectBtn">Connect to Device</button>
    <button id="disconnectBtn" disabled>Disconnect</button>

    <div class="stats">
        <div>Messages Sent: <span id="msgCount">0</span></div>
        <div>Bytes Sent: <span id="bytesSent">0</span></div>
        <div>Throughput: <span id="throughput">0</span> KB/s</div>
    </div>

    <div class="form-group">
        <label>Event Name:</label>
        <input type="text" id="eventName" value="TEST">
    </div>

    <div class="form-group">
        <label>Data:</label>
        <input type="text" id="eventData" value="Hello World">
    </div>

    <div class="form-group">
        <label>Receiver:</label>
        <input type="text" id="receiver" value="FF" size="2">
    </div>

    <div class="form-group">
        <label>Group:</label>
        <input type="text" id="group" value="00" size="2">
    </div>

    <div class="form-group">
        <label>Flags:</label>
        <input type="text" id="flags" value="80" size="2">
    </div>

    <button id="sendBtn" disabled>Send Message</button>
    <button id="startTest" disabled>Start Throughput Test</button>
    <button id="stopTest" disabled>Stop Test</button>

    <h3>Log</h3>
    <div id="log"></div>

    <script src="event-msg.js"></script>
    <script src="ble-handler.js"></script>
    <script>
        let bleHandler = new BleHandler();
        let testRunning = false;
        let startTime = 0;
        let totalBytes = 0;
        let messageCount = 0;

        function log(message, isDebug = false) {
            const logDiv = document.getElementById('log');
            const prefix = isDebug ? '<span style="color: #666">[DEBUG]</span> ' : '';
            logDiv.innerHTML += prefix + message + '<br>';
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        // Override console.log for debugging
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        console.log = function() {
            originalConsoleLog.apply(console, arguments);
            const message = Array.from(arguments).join(' ');
            log(message, true);
        };
        console.error = function() {
            originalConsoleError.apply(console, arguments);
            const message = Array.from(arguments).join(' ');
            log('<span style="color: red">' + message + '</span>', true);
        };

        function updateStats() {
            const elapsedTime = (Date.now() - startTime) / 1000;
            const throughput = totalBytes / (1024 * elapsedTime);

            document.getElementById('msgCount').textContent = messageCount;
            document.getElementById('bytesSent').textContent = totalBytes;
            document.getElementById('throughput').textContent = throughput.toFixed(2);
        }

        async function runThroughputTest() {
            if (!testRunning) return;

            try {
                const testData = "X".repeat(1500);
                await bleHandler.sendMessage("TEST", testData, 0xFF, 0x00, 0x80);
                totalBytes += testData.length;
                messageCount++;
                updateStats();
                
                if (testRunning) {
                    requestAnimationFrame(runThroughputTest);
                }
            } catch (error) {
                log('Error in throughput test: ' + error);
                stopThroughputTest();
            }
        }

        async function startThroughputTest() {
            document.getElementById('startTest').disabled = true;
            document.getElementById('stopTest').disabled = false;
            startTime = Date.now();
            totalBytes = 0;
            messageCount = 0;
            testRunning = true;
            runThroughputTest();
        }

        function stopThroughputTest() {
            document.getElementById('startTest').disabled = false;
            document.getElementById('stopTest').disabled = true;
            testRunning = false;
        }

        async function connect() {
            try {
                log('Connecting to BLE device...');
                const success = await bleHandler.connect();
                if (!success) throw new Error('Connection failed');

                bleHandler.onMessageReceived((name, data) => {
                    log(`Received Message:
    Event: ${name}
    Data: ${data}`);
                });

                log('Connected!');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                document.getElementById('startTest').disabled = false;

            } catch (error) {
                log('Error: ' + error);
            }
        }

        async function disconnect() {
            await bleHandler.disconnect();
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('startTest').disabled = true;
            document.getElementById('stopTest').disabled = true;
            log('Disconnected');
        }

        document.getElementById('connectBtn').addEventListener('click', connect);
        document.getElementById('disconnectBtn').addEventListener('click', disconnect);
        document.getElementById('sendBtn').addEventListener('click', async () => {
            const name = document.getElementById('eventName').value;
            const data = document.getElementById('eventData').value;
            const receiver = parseInt(document.getElementById('receiver').value, 16);
            const group = parseInt(document.getElementById('group').value, 16);
            const flags = parseInt(document.getElementById('flags').value, 16);

            await bleHandler.sendMessage(name, data, receiver, group, flags);
            totalBytes += data.length;
            messageCount++;
            updateStats();
        });
        document.getElementById('startTest').addEventListener('click', startThroughputTest);
        document.getElementById('stopTest').addEventListener('click', stopThroughputTest);
    </script>
</body>
</html>
